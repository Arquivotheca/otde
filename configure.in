# Original Author was Kalle@kde.org
# I lifted it in some mater. (Stephan Kulow)
# I used much code from Janos Farkas

dnl Process this file with autoconf to produce a configure script.

AC_INIT(acinclude.m4) dnl a source file from your sub dir
dnl AC_MSG_WARN("This Code is alpha. It may not even compile.  Use at your own risk.")
AC_CANONICAL_SYSTEM 
AC_ARG_PROGRAM
AC_ISC_POSIX

dnl Automake doc recommends to do this only here. (Janos)
AM_INIT_AUTOMAKE(kdebase, 0.10) dnl searches for some needed programs

dnl make $KDEDIR the default for the installation
AC_PREFIX_DEFAULT(${KDEDIR:-/usr/local/kde})

dnl generate the config header
AM_CONFIG_HEADER(config.h) dnl at the distribution this done

dnl checks, if the debug code is wanted
AC_CHECK_FLAGS

dnl Checks for programs.
AC_PROG_CC
AC_PROG_CPP
test "$CCC" = "" && CCC="c++ xlC DCC"
AC_PROG_CXX
AC_PROG_LN_S

AC_CHECK_LIB(dl, main, [LIBDL="-ldl"])
AC_SUBST(LIBDL)
AC_CHECK_HEADERS(dlfcn.h)
AC_ARG_ENABLE(dlopen,
[  --disable-dlopen        link kcontrol staticly [default=no]] ,   
[if test "$enableval" = yes; then
  enable_dlopen=yes
else
  enable_dlopen=no
fi],
enable_dlopen=yes)     

# override the user's opinion, if we know it better ;)
if test $ac_cv_header_dlfcn_h = "no" || test $ac_cv_lib_dl_main = "no"; then
  enable_dlopen=no
fi

if test $ac_cv_header_dlfcn_h = "yes" && test $ac_cv_lib_dl_main = "yes"; then
  AC_DEFINE_UNQUOTED(HAVE_DLFCN)
fi

if test "$enable_dlopen" = no ; then
  libtool_enable_shared=no
else
  libtool_enable_static=no
fi

dnl libtool is only for C, so I must force him
dnl to find the correct flags for C++
ac_save_cc=$CC
CC=$CXX
AM_PROG_LIBTOOL dnl for libraries
CC=$ac_save_cc

AC_MSG_CHECKING([dynamic loading])
eval "`egrep '^build_libtool_libs=' libtool`"
if test "$build_libtool_libs" = "yes" && test "$enable_dlopen" = "yes"; then
  dynamic_loading=yes
  AC_DEFINE_UNQUOTED(HAVE_DYNAMIC_LOADING)
else
  dynamic_loading=no
fi
AC_MSG_RESULT($dynamic_loading)

  for i in $files; do
    echo $ac_n "#include \".."$ac_c >> all_modules.new
    filename=`echo $i | sed -e "s#kcontrolcenter##"`
    echo "$filename\"" >> all_modules.new
  done
 
  echo "" >> all_modules.new
  echo "#define ADD_MODULES \\" >> all_modules.new

  for i in $files; do
    
    echo "#include \"$i\"" > conftest.c
    echo "ModuleList" >> conftest.c
    classname=`$CPP conftest.c 2> /dev/null | tail -1`
    echo "appendModuleList(new $classname()); \\" >> all_modules.new
    
    filename=`echo $i | sed -e "s#module.h#Makefile.am#"`
    libname=`grep lib_LTLIBRARIES $filename|sed -e "s#lib_LTLIBRARIES##"|sed -e "s#.*= *##"`
    filename=`echo "$i$libname" | sed -e "s#kcontrolcenter#\.\.#; s#module.h##"`
    KCC_MODULES="$KCC_MODULES $filename"
  done
  echo "// last line" >> all_modules.new
  if diff all_modules.new kcontrolcenter/kcc/all_modules.h 2> /dev/null > /dev/null; then
	   rm all_modules.new
  else
    mv all_modules.new kcontrolcenter/kcc/all_modules.h	
  fi 

if test "$dynamic_loading" = "no"; then
KCC_MODULES=\
"-dlpreopen ../sample/libsample.la "\
"-dlpreopen ../colors/libcolors.la "
else
KCC_MODULES=""
fi
AC_SUBST(KCC_MODULES)

kcc_moduledir="\$(prefix)/lib/kcc/modules"
AC_SUBST(kcc_moduledir)

dnl for NLS support. Call them in this order!
dnl WITH_NLS is for the po files
AM_KDE_WITH_NLS

dnl I need to check for libsocket before testing X
AC_CHECK_LIB(socket, socket, [LIBSOCKET="-lsocket -lnsl"]) dnl for Solaris
AC_SUBST(LIBSOCKET)
AC_PATH_KDE

AC_CHECK_KDM dnl in kdminclude.m4

case $host in 
*-*-linux* )
   AC_CHECK_HEADER(elf.h, 
	ac_have_shadow="yes",
        shadow_support="no"
     )
     ;;
esac

if test "$shadow_support" = "yes"; then
  AC_DEFINE(HAVE_SHADOW)
fi

if test "$SETUIDFLAGS" = ""; then 
 if test "$shadow_support" = "no"; then
  SETUIDFLAGS=""
 else
  SETUIDFLAGS="-m 4755"
 fi
else
 SETUIDFLAGS="-m $SETUIDFLAGS"
fi
AC_SUBST(SETUIDFLAGS)

AC_LANG_CPLUSPLUS
dnl Checks for libraries. 
AC_CHECK_LIB(compat, main, [LIBCOMPAT="-lcompat"]) dnl for FreeBSD
AC_SUBST(LIBCOMPAT)
AC_CHECK_LIB(crypt, main, [LIBCRYPT="-lcrypt"]) dnl for BSD
AC_SUBST(LIBCRYPT)

AC_FIND_GIF
AC_FIND_JPEG
AC_HAVE_GL(GL_SAVERS="kmorph3d.kss",GL_SAVERS="")
AC_SUBST(GL_SAVERS)
AC_HAVE_XPM(XPM_SAVERS="kbat.kss",XPM_SAVERS="")
AC_SUBST(XPM_SAVERS)

dnl Checks for header files.
AC_HEADER_DIRENT
AC_HEADER_STDC
AC_CHECK_HEADERS(fcntl.h sys/time.h unistd.h crypt.h sys/select.h \
	sys/ioctl.h sys/stropts.h termio.h termios.h lastlog.h malloc.h \
	sys/sockio.h crypt.h krb5/krb5.h rpc/rpc.h rpc/key_prot.h)

dnl Checks for typedefs, structures, and compiler characteristics.
AC_C_CONST
AC_C_INLINE
AC_HEADER_TIME

dnl check if the compiler has bool
AC_CHECK_BOOL
AC_C_LONG_DOUBLE
AC_TYPE_GETGROUPS

dnl Checks for library functions. MISCOBJS is for kdecore
AC_CHECK_FUNCS(socket powl sqrtl strdup getdtablesize vsnprintf setpgid usleep)
AC_CHECK_KSIZE_T
AC_CHECK_SETENV
AC_CHECK_GETDOMAINNAME
AC_CHECK_GETHOSTNAME

dnl output files
topdir=`pwd`
AC_SUBST(topdir)

KDE_RPATH="-rpath \$(kde_libraries)"
if test -n "$qt_libraries"; then
 KDE_RPATH="$KDE_RPATH -rpath \$(qt_libraries)"
fi
AC_SUBST(KDE_RPATH)

dnl Perform program name transformation
AC_ARG_PROGRAM

AC_OUTPUT(Makefile \
	kpanel/Makefile \
	kpanel/pics/Makefile \
	kdehelp/Makefile \
	kdehelp/index/Makefile \
	kdehelp/search/Makefile \
	kfm/Makefile \
	kfm/Desktop/Makefile \
	kfm/Desktop/Templates/Makefile \
	kfm/client/Makefile \
	kfm/kioslave/Makefile \
	kfm/pics/Makefile \
	kfm/kfmwarn/Makefile \
	kfm/kfmexec/Makefile \
	mimetypes/Makefile \
	mimetypes/application/Makefile \
	mimetypes/text/Makefile \
	mimetypes/video/Makefile \
	mimetypes/image/Makefile \
	mimetypes/text/Makefile \
	mimetypes/audio/Makefile \
	mimetypes/inode/Makefile \
	kfind/Makefile \
	kfind/pics/Makefile \
	kfontmanager/Makefile \
	kscreensaver/Makefile \
	kvt/Makefile \
	kwm/Makefile \
	kwm/pics/Makefile \
	pics/Makefile \
	pics/mini/Makefile \
	pics/toolbar/Makefile \
	pics/wallpapers/Makefile \
	kdm/Makefile \
	kdm/config/Makefile \
	kdm/pics/Makefile \
	kdm/xdmconfig/Makefile \
	kaudio/Makefile \
	kmenuedit/Makefile \
	kmenuedit/icons/Makefile \
	doc/Makefile \
	doc/kfm/Makefile \
	doc/kfind/Makefile \
	doc/kdehelp/Makefile \
	doc/kdisplay/Makefile \
	doc/kfontmanager/Makefile \
	doc/kdm/Makefile \
	doc/kwm/Makefile \
	doc/kvt/Makefile \
	doc/kmenuedit/Makefile \
	doc/kcc/Makefile \
	applnk/Applications/Makefile \
	applnk/Games/Makefile \
	applnk/Graphics/Makefile \
	applnk/Internet/Makefile \
	applnk/Multimedia/Makefile \
	applnk/System/Core/Makefile \
	applnk/System/Makefile \
	applnk/Utilities/Makefile \
	applnk/Makefile \
	kcontrolcenter/Makefile \
	kcontrolcenter/kcc/Makefile \
	kcontrolcenter/kcc/pics/Makefile \
	kcontrolcenter/sample/Makefile \
	kcontrolcenter/sample/pics/Makefile \
	kcontrolcenter/memory/Makefile \
	kcontrolcenter/memory/pics/Makefile \
	kcontrolcenter/processor/Makefile \
	kcontrolcenter/processor/pics/Makefile \
	kcontrolcenter/keyboard/Makefile \
	kcontrolcenter/keyboard/doc/Makefile \
	kcontrolcenter/keyboard/pics/Makefile \
	kcontrolcenter/bell/Makefile \
	kcontrolcenter/bell/doc/Makefile \
	kcontrolcenter/bell/pics/Makefile \
	kcontrolcenter/mouse/Makefile \
	kcontrolcenter/mouse/doc/Makefile \
	kcontrolcenter/mouse/pics/Makefile \
	kcontrolcenter/titlebar/Makefile \
	kcontrolcenter/titlebar/doc/Makefile \
	kcontrolcenter/titlebar/pics/Makefile \
	kcontrolcenter/smbstatus/Makefile \
	kcontrolcenter/smbstatus/pics/Makefile \
	kcontrolcenter/windows/Makefile \
	kcontrolcenter/windows/doc/Makefile \
	kcontrolcenter/windows/pics/Makefile \
	kcontrolcenter/display/pics/Makefile \
	kcontrolcenter/display/Makefile \
	po/Makefile \
	po/cs/Makefile \
	po/da/Makefile \
	po/de/Makefile \
	po/es/Makefile \
	po/fi/Makefile \
	po/fr/Makefile \
	po/it/Makefile \
	po/nl/Makefile \
	po/ru/Makefile \
	po/sv/Makefile \
	po/hu/Makefile \
	po/pl/Makefile \
	po/pt/Makefile \
	po/el/Makefile \
	kwmmodules/Makefile \
	kwmmodules/kwmpager/Makefile \
	kwmmodules/kbgndwm/Makefile \
	kwmcom/Makefile \
	krootwm/Makefile)

